#!/bin/sh

# [K]2022
# https://github.com/kongfl888

P1=${1}

Lovely(){
	local str=""
	local DATE_S=`date +%S`
	local t=`expr $DATE_S % 5`
	if [ "$t" == "1" ];then
		str="Hi Master, I'm your dnshelper. I'm very happy that you can come to see me."
	elif [ "$t" == "2" ];then
		str="Ha, what a good day today. Master."
	elif [ "$t" == "3" ];then
		str="ZZzz...Master?"
	elif [ "$t" == "4" ];then
		str="Oh, Master, nice to see you again."
	else
		str="Once upon a time,
there were a master and its helper who lived together under the sky.
And...The story is over. Thank you for watching.
Oh, that's a great story, isn't it? Master."
	fi
	echo ""
	echo "$str"
	echo ""
	exit 0
}

Helpthis() {
DATE_HMS=`date +%H:%M:%S`
DATE_Y=`date +%Y`
DATE="$DATE_Ymd $DATE_HMS"
echo "
Hi Master, I'm your dnshelper. You can use me in the following ways.

usage: my-dnshelper [OPTION]
    -h,--help       display this help and exit.

It is juest a part of me. You still need a luci application.
Thank you for coming to look at me. I'm very happy.
By MY-Dnshelper on $DATE

[K] $DATE_Y
You can contact my Founder via this link: https://github.com/kongfl888
"
exit 0
}

c=0

sharedir="/usr/share/my-dnshelper"
rmaker="$sharedir/rulesmaker"
source "$sharedir/comm"
guard=0

[ "$S" = "1" ] && SPath=$EPath/Rules

case $P1 in
	"-h"|"--help"|"-H")
	Helpthis
	;;
	"-g"|"-G")
	guard=1
	;;
	*)
	Lovely
	;;
esac

clear_log(){
	local dlogsize=0
	[ -s $1 ] && dlogsize=`ls -l $1 | awk '{ print $5 }'`
	if [ $dlogsize -gt $dnslogsize ]; then
			echo "`eval $D` Initialize dns log" > $dnsmasqlog
	fi
}


GuardA(){
	[ "$EA" == "1" ] || return
	[ -f "$helperconf" ] || $rmaker >> $Logfile
	if [ "$UDH" == "1" ];then
		[ -n "$(get_ports_ps)" -a ! -s "$mdhpconf" ] &&  $rmaker -d >> $Logfile
		[ -z "$(get_ports_ps)" -a -n "$(get_ports_cfg)" -a -s "$mdhpconf" ] &&  $rmaker -d >> $Logfile
	fi
	[ -f $resolvconf  ] || touch $resolvconf
	[ -s $resolvconf -a "$UDH" == "0" -a "$(get_rautoc)" != "$resolvconf" ] && $rmaker -d >> $Logfile
	if [ $(ping_ip "114.114.114.114") -eq 0 -a $(ping_ip "baidu.com") -ne 0 ];then
		echo "`eval $D` DNS may have some problems. Someting were wrong." >> $Logfile
		echo "`eval $D` Please restart my-dnshelper, or check other app." >> $Logfile
	fi
	[ "$(check_ln)" == "1" ] && $rmaker >> $Logfile

	if [ "$AUD" == "1" ]; then
		oldt=$(date -d "`cat $updatelog 2>/dev/null`" +%s 2>/dev/null)
		nowt=$(date +%s)
		[ -z "$oldt" ] && oldt=$nowt
		ctime=`expr $nowt - $oldt`
		utime=`expr $UPD \* 3600`
		[ "$UPD" == "0" ] && utime=1800
		[ $ctime -gt $utime ] && $rmaker -u >> $Logfile
	fi
}

if [ "$S" != "1" ]; then
	[ -d $EPath/Rules ] && cp -rf $EPath/Rules/* $RPath
fi

$rmaker >> $Logfile

if [ "$S" != "1" ]; then
	[ -e $EPath/Rules ] && rm -rf $EPath/Rules
fi
sleep 2s

while true; do
	sleep 60s
	GuardA
	clear_log
done
